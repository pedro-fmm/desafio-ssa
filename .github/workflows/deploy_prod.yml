name: Docker Push to Dockerhub

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    
jobs:

  pipeline:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2
      - name: docker login 
        env:
          DOCKER_USER: ${{secrets.DOCKER_USER}}
          DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD 
      
      - name: Tag and push image
        env:
          REGISTRY: pedrofmm
          REPOSITORY: desafio-ssa
          IMAGE_TAG: prod-${{ github.run_number }}
        run: |
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
          echo "::set-output name=image::$REGISTRY/$REPOSITORY:$IMAGE_TAG"

      - name: DigitalOcean App Platform deployment
        env:
          IMAGE_TAG: prod-${{ github.run_number }}
        uses: digitalocean/app_action@v1.0.0 # replace this with current version from https://github.com/digitalocean/app_action/releases
        with:
          app_name: clownfish-app
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          images: '[                
                    {
                      "name": "sample-add",
                      "image":{
                        "registry_type": "pedrofmm",
                        "registry": "pedrofmm",
                        "repository": "desafio-ssa",
                        "tag": $IMAGE_TAG
                      },
                      "envs": {"API_ENDPOINT": "https://api.mockytonk.com"},
                      "http_port": "5000"
                    }
                  ]'

                  name: clownfish-app
region: nyc
services:
- envs:
  - key: API_ENDPOINT
    scope: RUN_AND_BUILD_TIME
    value: https://api.mockytonk.com
  http_port: 5000
  image:
    registry: pedrofmm
    registry_type: DOCKER_HUB
    repository: desafio-ssa
    tag: prod-5
  instance_count: 1
  instance_size_slug: basic-xxs
  name: pedrofmm-desafio-ssa
  routes:
  - path: /


